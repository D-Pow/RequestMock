<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>bin/MockRequestsWebpackPlugin.js - Documentation</title>
    
    <meta name="description" content="MockRequests will mock both XMLHttpRequest and fetch such that any requested URL will return the specified mock object instead of actually making an async request. URLs not configured will be unaffected and still trigger an async request as normal." />
    
        <meta name="keywords" content="request HTTP requests XMLHttpRequest fetch mock mocks network" />
        <meta name="keyword" content="request HTTP requests XMLHttpRequest fetch mock mocks network" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h2><a href="./demo" >Demo</a></h2><h3>Modules</h3><ul><li><a href="module-mock-requests.html">mock-requests</a></li><li><a href="module-mock-requests_bin.html">mock-requests/bin</a></li><li></li></ul><h3>Namespaces</h3><ul><li><a href="module-mock-requests-MockRequests.html">MockRequests</a><ul class='methods'><li data-type='method'><a href="module-mock-requests-MockRequests.html#.configure">configure</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.configureDynamicResponses">configureDynamicResponses</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.setMockUrlResponse">setMockUrlResponse</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.setDynamicMockUrlResponse">setDynamicMockUrlResponse</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.getResponse">getResponse</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.deleteMockUrlResponse">deleteMockUrlResponse</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.clearAllMocks">clearAllMocks</a></li><li data-type='method'><a href="module-mock-requests-MockRequests.html#.mapStaticConfigToDynamic">mapStaticConfigToDynamic</a></li></ul></li><li><a href="module-mock-requests_bin-MockRequestsWebpackPlugin.html">MockRequestsWebpackPlugin</a></li><li><a href="module-mock-requests_bin-resolve-mocks.html">resolve-mocks</a><ul class='methods'><li data-type='method'><a href="module-mock-requests_bin-resolve-mocks.html#.resolveMocks">resolveMocks</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">bin/MockRequestsWebpackPlugin.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const path = require('path');
const { WebpackPluginInstance, Compiler } = require('webpack');

/**
 * @module mock-requests/bin
 */
/**
 * @namespace MockRequestsWebpackPlugin
 */

/**
 * Webpack plugin for automatically resolving the mock directory,
 * including transpiling all files it contains as well as adding
 * the entry file within it to the build/run output for the user.
 *
 * @extends WebpackPluginInstance
 * @memberOf module:mock-requests/bin~MockRequestsWebpackPlugin
 */
class MockRequestsWebpackPlugin {
    /**
     * Activates mock-requests based on the provided parameters.
     *
     * @param {string} mocksDir - Directory of all mock files/logic, including the `mockEntryFile`.
     * @param {string} mockEntryFile - Entry file that calls `MockRequests.configure()`.
     * @param {boolean} activateMocks - If mocks determined by `mockEntryFile` should be activated or not.
     * @param {Object} [options]
     * @param {boolean} [options.pathsAreAbsolute=false] - If `mocksDir` and `mockEntryFile` are absolute paths instead of relative.
     * @param {boolean} [options.transpileMocksDir=true] - If the files within `mocksDir` should be transpiled.
     * @memberOf module:mock-requests/bin~MockRequestsWebpackPlugin
     */
    constructor(
        mocksDir,
        mockEntryFile,
        activateMocks,
        {
            pathsAreAbsolute = false,
            transpileMocksDir = true
        } = {}
    ) {
        this.mocksDir = mocksDir;
        this.mockEntryFile = mockEntryFile;
        this.activateMocks = activateMocks;
        this.pathsAreAbsolute = pathsAreAbsolute;
        this.transpileMocksDir = transpileMocksDir;
    }

    get pluginName() {
        return this.constructor.name;
    }

    getAbsPath(projectRootPath, includeEntryFile = false) {
        let absPath = path.resolve(projectRootPath, this.mocksDir, includeEntryFile ? this.mockEntryFile : '');

        if (this.pathsAreAbsolute) {
            absPath = includeEntryFile ? this.mockEntryFile : this.mocksDir;
        }

        if (!fs.existsSync(absPath)) {
            return null;
        }

        return absPath;
    }

    injectMocksIntoWebpackConfig(projectRootPath, moduleRules, entry) {
        try {
            const firstEntryName = Object.keys(entry)[0];
            const firstEntryList = entry[firstEntryName].import;
            const mockDirAbsPath = this.getAbsPath(projectRootPath);
            const mockEntryAbsPath = this.getAbsPath(projectRootPath, true);

            if (!mockDirAbsPath) {
                throw new Error(`Could not find mock directory "${this.mocksDir}" from webpack context directory "${projectRootPath}"`);
            }

            if (!mockEntryAbsPath) {
                throw new Error(`Could not find mock entry file "${this.mockEntryFile}" from webpack context directory "${projectRootPath}"`);
            }

            const addedNewEntry = this.addMockEntryFileToConfigEntry(firstEntryList, mockEntryAbsPath);

            if (addedNewEntry) {
                this.addMockDirToModuleRule(moduleRules, mockDirAbsPath, mockEntryAbsPath);

                console.log('Network mocks activated by mock-requests.\n');
            }
        } catch (e) {
            console.error('Error:', e.message);
            console.error('Note:', this.pluginName, 'has only been verified for webpack@>=5. Webpack runtime issues may be fixed by upgrading.\n');
        }
    }

    addMockEntryFileToConfigEntry(configEntryList, mockEntryAbsPath) {
        if (configEntryList.includes(mockEntryAbsPath)) {
            // Mock entry file has already been added to webpack config
            // Don't add it again if a rebuild is triggered
            return false;
        }

        configEntryList.push(mockEntryAbsPath);

        return true;
    }

    addMockDirToModuleRule(moduleRules, mockDirAbsPath, mockEntryAbsPath) {
        if (!this.transpileMocksDir) {
            return;
        }

        const ruleTestMatchesMockDir = ruleTest => {
            if (ruleTest instanceof RegExp) {
                return ruleTest.test(mockEntryAbsPath);
            } else if (typeof ruleTest === typeof '') {
                return ruleTest.includes(mockDirAbsPath);
            } else if (typeof ruleTest === typeof this.constructor) {
                return ruleTest(this.mocksDir) || ruleTest(this.mockEntryFile) || ruleTest(mockDirAbsPath) || ruleTest(mockEntryAbsPath);
            } else if (Array.isArray(ruleTest)) {
                return ruleTest.some(ruleTestMatchesMockDir);
            } else { // is Object with and/or/not keys
                const allAndConditionsMet = ruleTest.and
                    ? ruleTest.and.reduce((matches, test) => matches &amp;&amp; ruleTestMatchesMockDir(test), true)
                    : true;
                const anyOrConditionsMet = ruleTest.or
                    ? ruleTest.or.some(ruleTestMatchesMockDir)
                    : true;
                const allNotConditionsMet = ruleTest.not
                    ? ruleTest.not.reduce((matches, test) => matches &amp;&amp; !ruleTestMatchesMockDir(test), true)
                    : true;

                return allAndConditionsMet &amp;&amp; anyOrConditionsMet &amp;&amp; allNotConditionsMet;
            }
        };

        const matchingRuleForMockEntryFile = moduleRules.find(rule => ruleTestMatchesMockDir(rule.test));

        if (matchingRuleForMockEntryFile) {
            const mockDirInclude = matchingRuleForMockEntryFile.include;

            if (mockDirInclude instanceof RegExp) {
                matchingRuleForMockEntryFile.include = [ mockDirInclude, mockDirAbsPath ];
            } else if (Array.isArray(mockDirInclude)) {
                mockDirInclude.push(mockDirAbsPath);
            }
        } else {
            throw new Error(
                `${this.pluginName}: Could not find a suitable \`module.rule.test\` for ${this.mockEntryFile}.`,
                `Try using either a RegExp or RegExp[] as a value for \`test\` to ensure proper transpilation of ${this.mocksDir}.`
            );
        }
    }

    /**
     * @param {Compiler} compiler
     */
    apply(compiler) {
        if (!this.activateMocks) {
            return;
        }

        const rules = compiler.options.module.rules;

        compiler.hooks.entryOption.tap(this.pluginName, (context, entry) => {
            if (typeof entry === typeof this.constructor) {
                entry().then(resolvedEntry => this.injectMocksIntoWebpackConfig(context, rules, resolvedEntry));
            } else {
                this.injectMocksIntoWebpackConfig(context, rules, entry);
            }
        });
    }
}

module.exports = MockRequestsWebpackPlugin;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
